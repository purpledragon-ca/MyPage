<!doctype html>
<html lang="zh">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Skill Tree · Pretty</title>
<link rel="stylesheet" href="../css/theme.css"/>
<link rel="stylesheet" href="../css/skilltree.css"/>
</head>
<body>
  <section class="hero">
    <div class="wrap">
      <h1 class="title">Skill Tree</h1>
      <p class="subtitle">支持折叠/搜索；叶子为按钮，点击跳到 Projects。</p>
      <div class="toolbar">
        <div class="search">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M21 21l-4.3-4.3m1.3-4.2a7 7 0 11-14 0 7 7 0 0114 0z" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>
          <input id="st-search" type="search" placeholder="搜索技能 / 节点… (Esc 清除)" autocomplete="off">
        </div>
        <button class="btn" id="st-expand">展开全部</button>
        <button class="btn" id="st-collapse">折叠全部</button>
        <button class="btn btn-primary" id="st-clear">清除过滤</button>
      </div>
    </div>
  </section>

  <main class="wrap">
    <div class="columns" id="st-columns">
      <!-- 树卡片将插入到这里 -->
    </div>
    <div class="footer">Tip：叶子项可在 Markdown 写成 “名称 [token]”，token 会作为 <code>?skill=</code>。</div>
  </main>

  <!-- 你的 Markdown：可自由增删分区（# Title）与缩进条目 -->
  <script type="text/markdown" id="skilltree-md">
# DeepLearning
- CV
  - Beginner
    - MINIST-CNN [mnist]
    - LA_Scar-Unet [unet]
  - Intermedia
    - Python
- SLAM
  - Intermedia
    - Leg_tracking [leg_tracking]
- Robot Control
  - RL
  - Control

# Basic
- ML
  - Beginner
    - RT-Leg_Tracker [rt-leg_tracker]
- CV
  - Beginner
    - April_Tag [april_tag]
    - Line Track [line track]
  - Intermedia
    - OpenCV2-FYP [opencv2]
- Control
  - Beginner
    - MPC [mpc]
    - PID [pid]
    
# DeepLearning
- CV
  - Beginner
    - MINIST-CNN [mnist]
    - LA_Scar-Unet [unet]
  - Intermedia
    - Python
- SLAM
  - Intermedia
    - Leg_tracking [leg_tracking]
- Robot Control
  - RL
  - Control

# Basic
- ML
  - Beginner
    - RT-Leg_Tracker [rt-leg_tracker]
- CV
  - Beginner
    - April_Tag [april_tag]
    - Line Track [line track]
  - Intermedia
    - OpenCV2-FYP [opencv2]
- Control
  - Beginner
    - MPC [mpc]
    - PID [pid]
  </script>

  <script>
  (function(){
    const PROJECTS_URL = "projects.html"; // ← 如需修改 Projects 路径，改这里
    const columnsEl = document.getElementById('st-columns');
    const searchEl = document.getElementById('st-search');
    const btnExpand = document.getElementById('st-expand');
    const btnCollapse = document.getElementById('st-collapse');
    const btnClear = document.getElementById('st-clear');

    const mdEl = document.getElementById('skilltree-md');
    const normTabs = s => s.replace(/\t/g,'  ');
    const norm = s => (s||'').toLowerCase().trim();
    const isLevel = label => {
      const t = norm(label);
      if (t === 'beginner') return 'begin';
      if (t === 'intermedia' || t === 'intermediate') return 'mid';
      if (t === 'advanced') return 'adv';
      if (t === 'expert') return 'exp';
      return null;
    };

    const newNode = (label, token=null) => ({ label, token, children:[] });

    function parse(md){
      const lines = normTabs(md).split(/\r?\n/).map(l=>l.replace(/\s+$/,''));
      const sections = []; // [{title, root}]
      let current = null;
      let stack = [];
      for(const line of lines){
        if(!line.trim()) continue;
        const h = line.match(/^#\s+(.+)$/);
        if(h){
          current = { title: h[1].trim(), root: newNode('__root__') };
          sections.push(current);
          stack = [ current.root ];
          continue;
        }
        const m = line.match(/^(\s*)-\s+(.+)$/);
        if(m && current){
          const indent = m[1].length;
          let text = m[2].trim();
          let label = text, token = null;
          const tk = text.match(/\[(.+?)\]\s*$/);
          if (tk){ token = tk[1].trim(); label = text.replace(/\[(.+?)\]\s*$/,'').trim(); }
          const level = Math.floor(indent/2) + 1; // 每 2 空格一层
          while(stack.length > level) stack.pop();
          while(stack.length < level) stack.push(stack[stack.length-1]); // 防御
          const parent = stack[stack.length-1];
          const node = newNode(label, token);
          parent.children.push(node);
          stack.push(node);
        }
      }
      return sections;
    }

    function gotoProjects(token){
      if(!token) return;
      const url = new URL(PROJECTS_URL, location.href);
      url.searchParams.set('skill', norm(token));
      location.href = url.toString();
    }

    // 渲染一棵树
    function renderTree(rootNode){
      const ul = document.createElement('ul');
      ul.className = 'tree';
      (rootNode.children||[]).forEach(ch => ul.appendChild(renderNode(ch)));
      return ul;
    }

    function renderNode(node){
      const li = document.createElement('li');
      li.className = 'li';
      li.dataset.label = node.label.toLowerCase();

      if(!node.children || node.children.length===0){
        // 叶子：按钮
        const btn = document.createElement('button');
        btn.className = 'leaf';
        btn.type = 'button';
        btn.textContent = node.label;
        const token = node.token || node.label;
        btn.addEventListener('click', ()=>gotoProjects(token));
        btn.addEventListener('keydown', e => { if(e.key==='Enter'||e.key===' '){ e.preventDefault(); gotoProjects(token);} });
        btn.setAttribute('aria-label','查看项目：'+node.label);
        li.appendChild(btn);
        return li;
      }

      // 分支：可折叠
      const head = document.createElement('span');
      head.className = 'node branch';
      head.innerHTML = `
        <svg class="caret" viewBox="0 0 24 24" aria-hidden="true"><path d="M8 5l8 7-8 7" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>
        <span class="lbl"></span>
      `;
      head.querySelector('.lbl').textContent = node.label;

      // 等级徽章
      const lv = isLevel(node.label);
      if(lv){
        const badge = document.createElement('span');
        badge.className = 'badge '+(
          lv==='begin' ? 'lv-begin' : lv==='mid' ? 'lv-mid' : lv==='adv' ? 'lv-adv' : 'lv-exp'
        );
        badge.textContent = node.label;
        head.querySelector('.lbl').textContent = ''; // 用徽章替换文本
        head.appendChild(badge);
      }

      head.setAttribute('role','button');
      head.setAttribute('tabindex','0');
      head.setAttribute('aria-expanded','true');

      const childUL = document.createElement('ul');
      node.children.forEach(c=> childUL.appendChild(renderNode(c)));

      // 交互：点击折叠/展开
      function toggle(){
        const collapsed = li.classList.toggle('collapsed');
        head.setAttribute('aria-expanded', String(!collapsed));
      }
      head.addEventListener('click', toggle);
      head.addEventListener('keydown', e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); toggle(); } });

      li.appendChild(head);
      li.appendChild(childUL);
      return li;
    }

    // 渲染所有分区到两列卡片
    function renderSections(sections){
      columnsEl.innerHTML = '';
      sections.forEach(sec=>{
        const card = document.createElement('section');
        card.className = 'card';
        const h2 = document.createElement('h2'); h2.textContent = sec.title;
        card.appendChild(h2);
        card.appendChild(renderTree(sec.root));
        columnsEl.appendChild(card);
      });
    }

    // 搜索过滤：匹配文本的 li 设为 .match，未匹配的隐藏。并展开其祖先。
    function applySearch(q){
      const allLi = columnsEl.querySelectorAll('.li');
      allLi.forEach(li=> li.classList.remove('match','hidden'));
      if(!q){ return; }
      const n = norm(q);
      allLi.forEach(li=>{
        const ok = li.dataset.label.includes(n);
        if(ok){
          li.classList.add('match');
          // 展开祖先
          let p = li.parentElement;
          while(p && p !== columnsEl){
            if(p.tagName==='UL'){ p = p.parentElement; continue; }
            if(p.classList.contains('li')){ p.classList.remove('collapsed'); p = p.parentElement; continue; }
            p = p.parentElement;
          }
        }
      });
      // 再隐藏未匹配项（没有 .match 且不含有任何后代 .match 的）
      allLi.forEach(li=>{
        if(li.classList.contains('match')) return;
        if(li.querySelector('.match')) return;
        li.classList.add('hidden');
      });
    }

    function expandAll(){ columnsEl.querySelectorAll('.li.collapsed').forEach(li=>li.classList.remove('collapsed')); }
    function collapseAll(){ columnsEl.querySelectorAll('.li').forEach(li=>{ if(li.querySelector('ul')) li.classList.add('collapsed'); }); }

    function main(){
      const md = (mdEl && mdEl.textContent) || '';
      const sections = parse(md);
      if(!sections.length){
        columnsEl.innerHTML = '<div class="card"><h2>提示</h2><p>未在 Markdown 中找到 <code># 标题</code> 与列表项。</p></div>';
        return;
      }
      renderSections(sections);

      // 绑定工具条
      searchEl.addEventListener('input', e=> applySearch(e.target.value));
      searchEl.addEventListener('keydown', e=>{ if(e.key==='Escape'){ searchEl.value=''; applySearch(''); } });
      btnExpand.addEventListener('click', expandAll);
      btnCollapse.addEventListener('click', collapseAll);
      btnClear.addEventListener('click', ()=>{ searchEl.value=''; applySearch(''); expandAll(); });
    }

    if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', main, {once:true});
    else main();
  })();
  </script>
</body>
</html>
